<%- include("../partials/navbar") %>

<div class="container mx-auto px-4 py-6">
    <!-- Product Overview Section -->
    <section class="mb-12">
        <div class="flex flex-col md:flex-row gap-8">
            <!-- Image Gallery -->
            <div class="w-full md:w-1/2">
                <div class="flex gap-4">
                    <!-- Thumbnails -->
                    <div class="flex flex-col gap-2 w-24">
                        <% product.images.forEach((image, index) => { %>
                            <img 
                                src="<%= image.path %>" 
                                alt="<%= product.name %> thumbnail" 
                                class="w-full aspect-square object-cover cursor-pointer thumbnail-img rounded-lg border border-gray-200 hover:border-[#8B4513] transition-all duration-300"
                                onclick="updateMainImage(this.src)"
                            >
                        <% }) %>
                    </div>

                    <!-- Main Image -->
                    <div class="flex-grow relative overflow-hidden rounded-xl h-[550px] shadow-xl">
                        <div class="image-zoom-container w-full h-full">
                            <img 
                                id="mainImage" 
                                src="<%= product.images[0].path %>" 
                                alt="<%= product.name %>" 
                                class="w-full h-full object-cover rounded-xl"
                            >
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Information -->
            <div class="w-full md:w-1/2">
                <div class="space-y-6">
                    <!-- Product Header -->
                    <div class="flex items-center justify-between border-b border-gray-200 pb-4">
                        <h1 class="text-2xl font-serif font-bold text-[#2c2c2c]"><%= product.name %></h1>
                        <button id="wishlistBtn" class="focus:outline-none transform hover:scale-110 transition-transform duration-300" onclick="toggleWishlist('<%= product._id %>')">
                            <i class="fas fa-heart text-2xl <%= isInWishlist ? 'text-red-500' : 'text-gray-400' %>"></i>
                        </button>
                    </div>

                    <!-- Description -->
                    <div class="border-b border-gray-200 pb-4">
                        <p class="text-gray-600 text-base font-serif leading-relaxed"><%= product.description %></p>
                    </div>

                    <!-- Product Details & Price -->
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Price Section -->
                        <div class="bg-[#8B4513]/5 p-4 rounded-xl shadow-sm">
                            <div class="flex flex-col gap-2">
                                <% const firstVariant = product.variants[0]; %>
                                <% const discountedPrice = Math.round(firstVariant.price * (1 - firstVariant.discount/100)); %>
                                <div class="flex flex-col gap-2">
                                    <div class="flex items-baseline gap-2">
                                        <span id="currentPrice" class="text-3xl font-bold text-[#8B4513]">₹<%= discountedPrice %></span>
                                        <% if (firstVariant.discount > 0) { %>
                                            <span id="originalPrice" class="text-lg text-gray-500 line-through">₹<%= firstVariant.price %></span>
                                        <% } %>
                                    </div>
                                    <% if (firstVariant.discount > 0) { %>
                                        <div class="flex justify-start">
                                            <span id="discountBadge" class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-xs font-medium max-w-[80px]">
                                                <%= firstVariant.discount %>% OFF
                                            </span>
                                        </div>
                                    <% } %>
                                </div>
                                <p id="stockStatus" class="font-medium text-sm">
                                    <% if (firstVariant.stock > 0) { %>
                                        <span class="text-green-600">In Stock (<%= firstVariant.stock %> available)</span>
                                    <% } else { %>
                                        <span class="text-red-600">Out of Stock</span>
                                    <% } %>
                                </p>
                            </div>
                        </div>

                        <!-- Product Details -->
                        <div class="bg-gray-50 p-4 rounded-xl shadow-sm space-y-2">
                            <div class="flex items-center gap-2">
                                <span class="font-medium text-gray-700 text-sm">Brand:</span>
                                <span class="text-gray-600 text-sm"><%= product.brand %></span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="font-medium text-gray-700 text-sm">Color:</span>
                                <span class="text-gray-600 text-sm"><%= product.color %></span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="font-medium text-gray-700 text-sm">Category:</span>
                                <span class="text-gray-600 text-sm"><%= product.category.name %></span>
                            </div>
                        </div>
                    </div>

                    <!-- Specifications -->
                    <div class="bg-white p-4 rounded-xl shadow-sm">
                        <h3 class="font-serif text-lg font-bold text-[#2c2c2c] mb-3">Specifications</h3>
                        <ul id="specsList" class="list-disc list-inside text-gray-600 space-y-2 text-sm">
                            <% if (product.variants[0].specifications && product.variants[0].specifications.length > 0) { %>
                                <% product.variants[0].specifications.forEach(spec => { %>
                                    <li><%= spec %></li>
                                <% }); %>
                            <% } else { %>
                                <li>No specifications available</li>
                            <% } %>
                        </ul>
                    </div>

                    <!-- Variant Selection -->
                    <div class="space-y-2">
                        <label class="block font-serif text-base font-medium text-gray-700">Select Variant:</label>
                        <select id="variantSelect" class="w-full p-2 border border-gray-300 text-gray-700 rounded-lg focus:border-[#8B4513] focus:outline-none font-serif hover:border-[#8B4513] transition-colors duration-300 text-sm" onchange="updateVariantDetails()">
                            <% product.variants.forEach((variant, index) => { %>
                                <option value="<%= index %>" 
                                        data-type="<%= variant.type %>"
                                        data-price="<%= variant.price %>"
                                        data-stock="<%= variant.stock %>"
                                        data-discount="<%= variant.discount %>"
                                        data-offer-name="<%= variant.offerName %>"
                                        data-specs='<%= JSON.stringify(variant.specifications || []) %>'
                                        data-in-cart="<%= variant.inCart %>"
                                        data-in-wishlist="<%= variant.inWishlist %>">
                                    <%= variant.type %> 
                                </option>
                            <% }) %>
                        </select>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-4">
                        <button id="cartBtn" onclick="handleCart('<%= product._id %>')" 
                                class="w-full text-white py-3 rounded-lg transition-colors duration-300 font-serif text-base disabled:bg-gray-400 shadow-lg hover:shadow-xl <%= product.variants[0].stock <= 0 ? 'bg-gray-400 cursor-not-allowed' : (initialCartStatus ? 'bg-red-600 hover:bg-red-700' : 'bg-[#8B4513] hover:bg-[#6B3513]') %>">
                            <%= product.variants[0].stock <= 0 ? 'Out of Stock' : (initialCartStatus ? 'Remove from Cart' : 'Add to Cart') %>
                        </button>
                        <button id="buyNowBtn" onclick="buyNow('<%= product._id %>')" 
                                class="hidden border-2 border-[#8B4513] py-3 rounded-lg hover:bg-[#8B4513]/5 transition-colors duration-300 font-serif text-base disabled:border-gray-400 disabled:text-gray-400 shadow-lg hover:shadow-xl">
                            Buy Now
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Similar Products Section -->
    <section>
        <div class="bg-white p-6 rounded-xl shadow-sm">
            <h2 class="text-2xl font-serif font-bold text-[#2c2c2c] mb-6 relative inline-block">
                Similar Products
                <div class="absolute bottom-0 left-0 w-20 h-[2px] bg-gradient-to-r from-transparent via-[#8B4513] to-transparent"></div>
            </h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                <% similarProducts.forEach(similar => { %>
                    <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden group transform hover:scale-[1.02] transition-all duration-300">
                        <a href="/product/view/<%= similar._id %>" class="block">
                            <div class="aspect-w-1 aspect-h-1 overflow-hidden">
                                <img 
                                    src="<%= similar.images[0].path %>" 
                                    alt="<%= similar.name %>"
                                    class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500 product-image"
                                    data-fallback="/images/placeholder.jpg"
                                >
                            </div>
                            <div class="p-4">
                                <h3 class="text-sm font-serif mb-1 text-gray-800 group-hover:text-[#8B4513] transition-colors duration-300"><%= similar.name %></h3>
                                <p class="text-gray-600 mb-2 font-serif text-xs"><%= similar.brand || 'No brand' %></p>
                                <div class="flex justify-between items-center mb-2">
                                    <div class="flex items-center gap-1">
                                        <% const similarVariant = similar.variants[0]; %>
                                        <% 
                                        const hasOffer = similar.offer && similar.offer.discount > 0;
                                        const similarDiscountedPrice = hasOffer ? 
                                            Math.round(similarVariant.price * (1 - similar.offer.discount/100)) : 
                                            similarVariant.price; 
                                        %>
                                        <span class="text-base font-serif text-[#8B4513]">₹<%= similarDiscountedPrice %></span>
                                        <% if (hasOffer) { %>
                                            <span class="text-xs text-gray-500 line-through">₹<%= similarVariant.price %></span>
                                            <span class="text-xs text-[#8B4513] font-serif ml-1"><%= similar.offer.discount %>% OFF</span>
                                        <% } %>
                                    </div>
                                    <button class="wishlist-toggle text-gray-600 hover:text-red-500 transition-colors" 
                                            onclick="event.preventDefault(); event.stopPropagation(); toggleWishlist('<%= similar._id %>', this);"
                                            data-product-id="<%= similar._id %>"
                                            data-variant-type="<%= similar.variants[0].type %>"
                                            data-in-wishlist="<%= similar.variants[0].inWishlist ? 'true' : 'false' %>">
                                        <i class="<%= similar.variants[0].inWishlist ? 'fas fa-heart text-red-500' : 'far fa-heart' %>"></i>
                                    </button>
                                </div>
                            </div>
                        </a>
                        <div class="p-4 pt-0">
                            <div class="flex flex-col gap-2">
                                <select class="variant-select w-full p-2 text-xs border border-gray-200 text-gray-700 rounded-lg focus:border-[#8B4513] focus:outline-none font-serif hover:border-[#8B4513] transition-colors duration-300" data-product-id="<%= similar._id %>">
                                    <% if (similar.variants && similar.variants.length > 0) { %>
                                        <% similar.variants.forEach(variant => { %>
                                            <option value="<%= variant.type %>" 
                                                    data-stock="<%= variant.stock %>" 
                                                    data-price="<%= variant.price %>"
                                                    data-in-wishlist="<%= variant.inWishlist ? 'true' : 'false' %>"
                                                    data-in-cart="<%= variant.inCart ? 'true' : 'false' %>">
                                                <%= variant.type %> - ₹<%= variant.price %>
                                            </option>
                                        <% }) %>
                                    <% } else { %>
                                        <option value="default">No variants available</option>
                                    <% } %>
                                </select>
                                <button 
                                    class="add-to-cart-btn w-full bg-gradient-to-r from-gray-900 to-gray-800 text-white py-2 text-xs uppercase hover:from-gray-800 hover:to-gray-700 transition-all duration-300 font-serif rounded-lg group" 
                                    onclick="event.preventDefault(); event.stopPropagation(); handleCart('<%= similar._id %>', this);"
                                    data-product-id="<%= similar._id %>"
                                    data-action="<%= similar.variants[0].inCart ? 'remove' : 'add' %>">
                                    <%= similar.variants[0].inCart ? 'Remove from Cart' : 'Add to Cart' %>
                                    <span class="inline-block transform group-hover:translate-x-1 transition-transform duration-300 ml-1">→</span>
                                </button>
                            </div>
                        </div>
                    </div>
                <% }); %>
            </div>
        </div>
    </section>
</div>

<%- include("../partials/footer") %>

<style>
.image-zoom-container {
    position: relative;
    overflow: hidden;
    cursor: zoom-in;
}

.image-zoom-container img {
    transition: transform 0.3s ease;
    transform-origin: center center;
}

.zoomed {
    position: relative;
    transform: scale(2);
}

.zoom-lens {
    position: absolute;
    border: 2px solid #d1d5db;
    width: 150px;
    height: 150px;
    cursor: none;
    background-color: rgba(255, 255, 255, 0.4);
    display: none;
    z-index: 10;
}

.zoom-result {
    position: absolute;
    border: 2px solid #d1d5db;
    width: 150px;
    height: 150px;
    overflow: hidden;
    display: none;
    z-index: 20;
    background-color: white;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.zoom-result img {
    position: absolute;
    max-width: none;
    max-height: none;
}

.thumbnail-img {
    transition: all 0.3s ease;
}

.thumbnail-img:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

#variantSelect {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%238B4513'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    background-size: 1.5em;
    padding-right: 2.5rem;
    appearance: none;
}

#cartBtn, #buyNowBtn {
    transition: all 0.3s ease;
}

#cartBtn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(139, 69, 19, 0.2);
}

#buyNowBtn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(139, 69, 19, 0.1);
}
</style>

<script>
function updateMainImage(src) {
    const mainImage = document.getElementById('mainImage');
    mainImage.src = src;
    // Reset zoom state when changing images
    mainImage.classList.remove('zoomed');
    mainImage.style.transformOrigin = 'center center';
    
    // Reset zoom lens and result
    const zoomLens = document.querySelector('.zoom-lens');
    const zoomResult = document.querySelector('.zoom-result');
    if (zoomLens) zoomLens.style.display = 'none';
    if (zoomResult) zoomResult.style.display = 'none';
    
    // Update zoomed image source
    const zoomedImg = document.querySelector('.zoom-result img');
    if (zoomedImg) zoomedImg.src = src;
}

function updateCartButton(inCart) {
    const cartBtn = document.getElementById('cartBtn');
    if (inCart) {
        cartBtn.textContent = 'Remove from Cart';
        cartBtn.classList.remove('bg-[#8B4513]', 'hover:bg-[#6B3513]');
        cartBtn.classList.add('bg-red-600', 'hover:bg-red-700');
    } else {
        cartBtn.textContent = 'Add to Cart';
        cartBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
        cartBtn.classList.add('bg-[#8B4513]', 'hover:bg-[#6B3513]');
    }
}

function updateVariantDetails() {
    const select = document.getElementById('variantSelect');
    const selectedOption = select.options[select.selectedIndex];
    const cartBtn = document.getElementById('cartBtn');
    const buyNowBtn = document.getElementById('buyNowBtn');
    
    // Update price
    const price = selectedOption.getAttribute('data-price');
    const discount = selectedOption.getAttribute('data-discount');
    const discountedPrice = Math.round(price * (1 - discount/100));

    document.getElementById('currentPrice').textContent = `₹${discountedPrice}`;
    document.getElementById('originalPrice').textContent = `₹${price}`;
    
    // Update discount badge
    const discountBadge = document.getElementById('discountBadge');
    if (discount > 0) {
        discountBadge.textContent = `${discount}% OFF`;
        discountBadge.style.display = 'block';
    } else {
        discountBadge.style.display = 'none';
    }
    
    // Update stock status
    const stock = selectedOption.getAttribute('data-stock');
    const stockStatus = document.getElementById('stockStatus');
    if (stock > 0) {
        stockStatus.innerHTML = `<span class="text-green-600">In Stock (${stock} available)</span>`;
        cartBtn.disabled = false;
        buyNowBtn.disabled = false;
    } else {
        stockStatus.innerHTML = '<span class="text-red-600">Out of Stock</span>';
        cartBtn.disabled = true;
        buyNowBtn.disabled = true;
    }
    
    // Update cart button state
    const inCart = selectedOption.getAttribute('data-in-cart') === 'true';
    updateCartButtonState(cartBtn, inCart);
}

// Function to handle cart actions
async function handleCart(productId, button = null) {
    let variantSelect;
    let selectedOption;
    let variantType;
    let stock;
    let cartBtn;
    let action;

    if (button) {
        // For similar products
        cartBtn = button;
        variantSelect = document.querySelector(`.variant-select[data-product-id="${productId}"]`);
        selectedOption = variantSelect.options[variantSelect.selectedIndex];
        variantType = selectedOption.value;
        stock = parseInt(selectedOption.getAttribute('data-stock'));
        action = cartBtn.getAttribute('data-action');
    } else {
        // For main product
        cartBtn = document.getElementById('cartBtn');
        variantSelect = document.getElementById('variantSelect');
        selectedOption = variantSelect.options[variantSelect.selectedIndex];
        variantType = selectedOption.getAttribute('data-type');
        stock = parseInt(selectedOption.getAttribute('data-stock'));
        action = cartBtn.textContent.trim() === 'Add to Cart' ? 'add' : 'remove';
    }
    
    // Check if product is in stock (only for add action)
    if (action === 'add' && stock <= 0) {
        Swal.fire({
            icon: 'error',
            title: 'Out of Stock',
            text: 'This variant is currently out of stock'
        });
        return;
    }
    
    try {
        // Show loading state
        Swal.fire({
            title: action === 'add' ? 'Adding to Cart...' : 'Removing from Cart...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        const response = await fetch(action === 'add' ? '/cart/add' : '/cart/remove', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                productId,
                variantType
            })
        });

        const data = await response.json();

        if (data.success) {
            // Close loading state
            Swal.close();

            // Update cart count in navbar using the global function
            if (typeof window.updateCartCount === 'function' && data.cartCount !== undefined) {
                window.updateCartCount(data.cartCount);
            }

            // Update button state
            if (button) {
                // For similar products - only update text and action
                if (action === 'add') {
                    cartBtn.textContent = 'Remove from Cart';
                    cartBtn.setAttribute('data-action', 'remove');
                } else {
                    cartBtn.textContent = 'Add to Cart';
                    cartBtn.setAttribute('data-action', 'add');
                }
            } else {
                // For main product
                updateCartButtonState(cartBtn, action === 'add');
            }

            // Update variant option data attribute
            selectedOption.setAttribute('data-in-cart', (action === 'add').toString());

            // Show success message
            await Swal.fire({
                icon: 'success',
                title: action === 'add' ? 'Added to Cart!' : 'Removed from Cart!',
                text: action === 'add' ? 
                    `${variantType} added to cart successfully` : 
                    `${variantType} removed from cart successfully`,
                showConfirmButton: false,
                timer: 1500
            });
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        console.error('Cart operation error:', error);
        // Close loading state
        Swal.close();

        // Show error message
        await Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: error.message || `Failed to ${action} from cart`
        });
    }
}

// Function to update cart button state
function updateCartButtonState(button, inCart) {
    if (inCart) {
        button.textContent = 'Remove from Cart';
        button.setAttribute('data-action', 'remove');
    } else {
        button.textContent = 'Add to Cart';
        button.setAttribute('data-action', 'add');
    }
}

// Function to handle buy now
function buyNow(productId) {
    const select = document.getElementById('variantSelect');
    const selectedOption = select.options[select.selectedIndex];
    const variantType = selectedOption.getAttribute('data-type');
    const stock = parseInt(selectedOption.getAttribute('data-stock'));
    
    if (stock <= 0) {
        Swal.fire({
            icon: 'error',
            title: 'Out of Stock',
            text: 'This variant is currently out of stock'
        });
        return;
    }
    
    // Redirect to checkout with product details
    window.location.href = `/checkout?productId=${productId}&variantType=${variantType}`;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Initialize main product cart button
    const mainCartBtn = document.getElementById('cartBtn');
    const mainVariantSelect = document.getElementById('variantSelect');
    const initialInCart = mainVariantSelect.options[mainVariantSelect.selectedIndex].getAttribute('data-in-cart') === 'true';
    updateCartButtonState(mainCartBtn, initialInCart);

    // Initialize similar products cart buttons
    document.querySelectorAll('.add-to-cart-btn').forEach(button => {
        const productId = button.getAttribute('data-product-id');
        const variantSelect = document.querySelector(`.variant-select[data-product-id="${productId}"]`);
        const option = variantSelect.options[variantSelect.selectedIndex];
        const inCart = option.getAttribute('data-in-cart') === 'true';
        
        // Only update text and action, keep original styling
        if (inCart) {
            button.textContent = 'Remove from Cart';
            button.setAttribute('data-action', 'remove');
        } else {
            button.textContent = 'Add to Cart';
            button.setAttribute('data-action', 'add');
        }
    });

    // Initialize wishlist icons
    document.querySelectorAll('.wishlist-toggle').forEach(button => {
        const inWishlist = button.getAttribute('data-in-wishlist') === 'true';
        const icon = button.querySelector('i');
        if (inWishlist) {
            icon.classList.remove('far');
            icon.classList.add('fas', 'text-red-500');
        } else {
            icon.classList.remove('fas', 'text-red-500');
            icon.classList.add('far');
        }
    });

    // Add event listeners for variant changes
    document.querySelectorAll('.variant-select').forEach(select => {
        select.addEventListener('change', function() {
            const productId = this.getAttribute('data-product-id');
            const option = this.options[this.selectedIndex];
            const inCart = option.getAttribute('data-in-cart') === 'true';
            const inWishlist = option.getAttribute('data-in-wishlist') === 'true';
            
            // Update the corresponding cart button - only text and action
            const cartBtn = document.querySelector(`.add-to-cart-btn[data-product-id="${productId}"]`);
            if (cartBtn) {
                if (inCart) {
                    cartBtn.textContent = 'Remove from Cart';
                    cartBtn.setAttribute('data-action', 'remove');
                } else {
                    cartBtn.textContent = 'Add to Cart';
                    cartBtn.setAttribute('data-action', 'add');
                }
            }

            // Update wishlist icon
            const wishlistBtn = document.querySelector(`.wishlist-toggle[data-product-id="${productId}"]`);
            if (wishlistBtn) {
                wishlistBtn.setAttribute('data-variant-type', option.value);
                wishlistBtn.setAttribute('data-in-wishlist', inWishlist.toString());
                const icon = wishlistBtn.querySelector('i');
                if (inWishlist) {
                    icon.classList.remove('far');
                    icon.classList.add('fas', 'text-red-500');
                } else {
                    icon.classList.remove('fas', 'text-red-500');
                    icon.classList.add('far');
                }
            }
        });
    });

    // Handle image loading errors
    document.querySelectorAll('.product-image').forEach(img => {
        img.addEventListener('error', function() {
            const fallback = this.getAttribute('data-fallback');
            if (fallback && this.src !== fallback) {
                this.src = fallback;
            }
        });
    });
});

async function toggleWishlist(productId, button = null) {
    let variantType;
    let selectedVariant;
    
    if (button) {
        // For similar products
        variantType = button.getAttribute('data-variant-type');
        const variantSelect = document.querySelector(`.variant-select[data-product-id="${productId}"]`);
        selectedVariant = variantSelect.options[variantSelect.selectedIndex];
    } else {
        // For main product
    const variantSelect = document.getElementById('variantSelect');
        selectedVariant = variantSelect.options[variantSelect.selectedIndex];
        variantType = selectedVariant.getAttribute('data-type');
    }

    if (!variantType) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Please select a variant first',
            confirmButtonColor: '#000',
            showConfirmButton: false,
            timer: 2000
        });
        return;
    }

    // Show loading state
    Swal.fire({
        title: 'Updating wishlist...',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    try {
        const response = await fetch(`/wishlist/toggle/${productId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            variantType
        })
        });
        
        const data = await response.json();
        
        if (data.success) {
            let wishlistBtn;
            let wishlistIcon;
            
            if (button) {
                // For similar products
                wishlistBtn = button;
                wishlistIcon = button.querySelector('i');
            } else {
                // For main product
                wishlistBtn = document.getElementById('wishlistBtn');
                wishlistIcon = wishlistBtn.querySelector('i');
            }
            
            if (data.added) {
                // Product was added to wishlist
                wishlistIcon.classList.remove('far', 'text-gray-400');
                wishlistIcon.classList.add('fas', 'text-red-500');
            } else {
                // Product was removed from wishlist
                wishlistIcon.classList.remove('fas', 'text-red-500');
                wishlistIcon.classList.add('far', 'text-gray-400');
            }

            // Update the variant's wishlist status
            selectedVariant.setAttribute('data-in-wishlist', data.added);

            // Update wishlist count in navbar
            const navbarWishlistIcon = document.querySelector('.fa-heart').parentElement;
            let wishlistBadge = navbarWishlistIcon.querySelector('.cart-badge');
            
            if (data.wishlistCount > 0) {
                if (!wishlistBadge) {
                    wishlistBadge = document.createElement('span');
                    wishlistBadge.className = 'cart-badge absolute -top-1 -right-1 rounded-full flex items-center justify-center';
                    navbarWishlistIcon.appendChild(wishlistBadge);
                }
                wishlistBadge.textContent = data.wishlistCount;
            } else if (wishlistBadge) {
                wishlistBadge.remove();
            }

            // Show success message
            await Swal.fire({
                icon: data.added ? 'success' : 'info',
                title: data.added ? 'Added to Wishlist' : 'Removed from Wishlist',
                text: data.added ? 'This product has been added to your wishlist' : 'This product has been removed from your wishlist',
                confirmButtonColor: '#000',
                showConfirmButton: false,
                timer: 2000
            });
        } else {
            throw new Error(data.message || 'Something went wrong');
        }
    } catch (error) {
        console.error('Error toggling wishlist:', error);
        await Swal.fire({
            icon: 'error',
            title: 'Error',
            text: error.message || 'Failed to update wishlist. Please try again.',
            confirmButtonColor: '#000',
            showConfirmButton: false,
            timer: 2000
        });
    }
}
</script>
