<%- include("../partials/navbar") %>

    <div class="justify-center items-center h-screen flex">
        <div class="rounded-lg shadow-lg w-80 border-2 p-8">
            <h2 class="text-center text-xl font-semibold text-gray-700 mb-4">Sign Up</h2>
            <form id="signupForm" class="space-y-4" novalidate>
                <div class="space-y-4">
                    <div>
                        <input id="firstName" type="text" placeholder="First Name"
                            class="border-gray-300 rounded w-full px-4 py-2 bg-gray-200 focus:outline-none focus:ring-2 focus:ring-black" />
                        <p class="text-red-500 text-xs mt-1 hidden" id="firstNameError"></p>
                    </div>

                    <div>
                        <input id="lastName" type="text" placeholder="Last Name"
                            class="border-gray-300 rounded w-full px-4 py-2 bg-gray-200 focus:outline-none focus:ring-2 focus:ring-black" />
                        <p class="text-red-500 text-xs mt-1 hidden" id="lastNameError"></p>
                    </div>

                    <div>
                        <input id="email" type="email" placeholder="Email"
                            class="border-gray-300 rounded w-full px-4 py-2 bg-gray-200 focus:outline-none focus:ring-2 focus:ring-black" />
                        <p class="text-red-500 text-xs mt-1 hidden" id="emailError"></p>
                    </div>

                    <div>
                        <input id="password" type="password" placeholder="Password"
                            class="border-gray-300 rounded w-full px-4 py-2 bg-gray-200 focus:outline-none focus:ring-2 focus:ring-black" />
                        <p class="text-red-500 text-xs mt-1 hidden" id="passwordError"></p>
                    </div>

                    <div>
                        <input id="confirmPassword" type="password" placeholder="Confirm Password"
                            class="border-gray-300 rounded w-full px-4 py-2 bg-gray-200 focus:outline-none focus:ring-2 focus:ring-black" />
                        <p class="text-red-500 text-xs mt-1 hidden" id="confirmPasswordError"></p>
                    </div>
                </div>
                <button type="submit" id="signupButton"
                    class="rounded w-full py-2 mt-4 bg-black text-white hover:bg-gray-800 transition-colors duration-200 disabled:bg-gray-400">
                    Sign Up
                </button>
            </form>
            <p class="text-center text-gray-500 mt-4">Already have an account?
                <a href="/" class="text-blue-500 hover:underline">Login</a>
            </p>

            <!-- Google Sign in -->
            <div id="google-auth-div" class="flex justify-center">
                <a class="inline-flex mt-4 px-2 py-1 border rounded-lg hover:bg-gray-50 transition-colors duration-200" href="/auth/google?trigger=signup">
                    <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google logo" class="w-5 h-5">
                </a>
            </div>
        </div>
    </div>

    <%- include("../partials/footer") %>

    <script>
        const signupForm = document.getElementById('signupForm');
        const signupButton = document.getElementById('signupButton');

        // Validation functions
        function validateFirstName(firstName) {
            if (!firstName) return 'First name is required';
            if (firstName.length < 2) return 'First name must be at least 2 characters';
            if (!/^[a-zA-Z\s]+$/.test(firstName)) return 'First name should only contain letters';
            return '';
        }

        function validateLastName(lastName) {
            if (!lastName) return 'Last name is required';
            if (lastName.length < 2) return 'Last name must be at least 2 characters';
            if (!/^[a-zA-Z\s]+$/.test(lastName)) return 'Last name should only contain letters';
            return '';
        }

        function validateEmail(email) {
            if (!email) return 'Email is required';
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) return 'Please enter a valid email address';
            return '';
        }

        function validatePassword(password) {
            if (!password) return 'Password is required';
            if (password.length < 8) return 'Password must be at least 8 characters';
            if (!/[A-Z]/.test(password)) return 'Password must contain at least one uppercase letter';
            if (!/[a-z]/.test(password)) return 'Password must contain at least one lowercase letter';
            if (!/[0-9]/.test(password)) return 'Password must contain at least one number';
            if (!/[!@#$%^&*]/.test(password)) return 'Password must contain at least one special character (!@#$%^&*)';
            return '';
        }

        function validateConfirmPassword(password, confirmPassword) {
            if (!confirmPassword) return 'Please confirm your password';
            if (password !== confirmPassword) return 'Passwords do not match';
            return '';
        }

        // Real-time validation
        document.getElementById('firstName').addEventListener('input', function(e) {
            const error = validateFirstName(e.target.value);
            document.getElementById('firstNameError').textContent = error;
            document.getElementById('firstNameError').classList.toggle('hidden', !error);
        });

        document.getElementById('lastName').addEventListener('input', function(e) {
            const error = validateLastName(e.target.value);
            document.getElementById('lastNameError').textContent = error;
            document.getElementById('lastNameError').classList.toggle('hidden', !error);
        });

        document.getElementById('email').addEventListener('input', function(e) {
            const error = validateEmail(e.target.value);
            document.getElementById('emailError').textContent = error;
            document.getElementById('emailError').classList.toggle('hidden', !error);
        });

        document.getElementById('password').addEventListener('input', function(e) {
            const error = validatePassword(e.target.value);
            document.getElementById('passwordError').textContent = error;
            document.getElementById('passwordError').classList.toggle('hidden', !error);

            // Also validate confirm password if it has a value
            const confirmPassword = document.getElementById('confirmPassword');
            if (confirmPassword.value) {
                const confirmError = validateConfirmPassword(e.target.value, confirmPassword.value);
                document.getElementById('confirmPasswordError').textContent = confirmError;
                document.getElementById('confirmPasswordError').classList.toggle('hidden', !confirmError);
            }
        });

        document.getElementById('confirmPassword').addEventListener('input', function(e) {
            const password = document.getElementById('password').value;
            const error = validateConfirmPassword(password, e.target.value);
            document.getElementById('confirmPasswordError').textContent = error;
            document.getElementById('confirmPasswordError').classList.toggle('hidden', !error);
        });

        document.getElementById('signupForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Show loading state
            Swal.fire({
                title: 'Processing...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                const response = await fetch('/signup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        firstName,
                        lastName,
                        email,
                        password,
                        confirmPassword
                    })
                });

                const data = await response.json();

                if (data.success) {
                    await Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: data.message,
                        confirmButtonColor: '#000'
                    });
                    
                    // Redirect to OTP page
                    window.location.href = data.redirect || '/otpPage';
                } else {
                    await Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: data.message,
                        confirmButtonColor: '#000'
                    });
                }
            } catch (error) {
                await Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'An error occurred. Please try again.',
                    confirmButtonColor: '#000'
                });
            }
        });
    </script>